{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "cdpxdockerusername": {
      "type": "securestring",
      "metadata": {
        "description": "trydotnetcdpx user name"
      }
    },
    "cdpxdockerpassword": {
      "type": "securestring",
      "metadata": {
        "description": "trydotnetcdpx password"
      }
    },
    "containerappkey": {
      "type": "securestring",
      "metadata": {
        "description": "Service principal"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2014-04-01",
      "name": "westus_tdna_ai",
      "location": "West US 2",
      "properties": {
        "applicationId": "westus_tdna_ai"
      },
      "dependsOn": []
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "kind": "linux",
      "apiVersion": "2016-09-01",
      "name": "westus_tdna_sf",
      "sku": {
        "name": "S3",
        "tier": "Standard",
        "size": "S3",
        "family": "S",
        "capacity": 10
      },
      "properties": {
        "reserved": true,
        "name": "westus_tdna_sf"
      },
      "location": "[resourceGroup().location]",
      "dependsOn": []
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2016-08-01",
      "name": "trydotnetagent-westus",
      "location": "East US",
      "properties": {
        "reserved": true,
        "serverFarmId": "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Web/serverfarms', 'westus_tdna_sf')]"
      },
      "resources": [
        {
          "type": "config",
          "name": "appsettings",
          "apiVersion": "2016-08-01",
          "properties": {
            "DOCKER_REGISTRY_SERVER_URL": "https://trydotnetcdpx.azurecr.io",
            "DOCKER_REGISTRY_SERVER_USERNAME": "[parameters('cdpxdockerusername')]",
            "DOCKER_REGISTRY_SERVER_PASSWORD": "[parameters('cdpxdockerpassword')]",
            "DOCKER_CUSTOM_IMAGE_NAME": "trydotnetcdpx.azurecr.io/mls.orchestrator:"
          },
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', 'trydotnetagent-westus')]"
          ]
        },
        {
          "type": "config",
          "name": "connectionstrings",
          "apiVersion": "2016-08-01",
          "properties": {
            "Insights_Key": {
              "type": "Custom",
              "value": "[reference(resourceId('Microsoft.Insights/components', 'westus_tdna_ai'), '2014-04-01').InstrumentationKey]"
            },
            "Insights_DeveloperMode": {
              "type": "Custom",
              "value": "false"
            }
          },
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', 'trydotnetagent-westus')]"
          ]
        }
      ],
      "kind": "app,linux,container",
      "dependsOn": [
        "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Insights/components', 'westus_tdna_ai')]",
        "[resourceId(subscription().subscriptionId, resourceGroup().name, 'Microsoft.Web/serverfarms', 'westus_tdna_sf')]"
      ]
    }
  ]
}